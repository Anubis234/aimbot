-- Check if the script is running in a Roblox environment
if not game or not game.GetService then
    error("This script must be run in a Roblox environment where 'game' is defined.")
end

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local aimbotEnabled = false
local espEnabled = false

-- Basic Security Measures
local function obfuscateString(str)
    local obfuscated = ""
    for i = 1, #str do
        obfuscated = obfuscated .. string.char(bit.bxor(string.byte(str, i), 17))
    end
    return obfuscated
end

local function unobfuscateString(str)
    local original = ""
    for i = 1, #str do
        original = original .. string.char(bit.bxor(string.byte(str, i), 17))
    end
    return original
end

local originalStrings = {
    "Mafia",
    "Welcome, " .. LocalPlayer.Name .. "!",
    "Toggle Aimbot",
    "Toggle ESP"
}

local obfuscatedStrings = {}
for i, str in ipairs(originalStrings) do
    table.insert(obfuscatedStrings, obfuscateString(str))
end

-- Create GUI
local ScreenGui = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local AimbotButton = Instance.new("TextButton")
local ESPButton = Instance.new("TextButton")
local Title = Instance.new("TextLabel")
local WelcomeMessage = Instance.new("TextLabel")
local AvatarImage = Instance.new("ImageLabel")
local CloseButton = Instance.new("TextButton")

ScreenGui.Name = unobfuscateString(obfuscatedStrings[1])
ScreenGui.Parent = game.CoreGui

Frame.Parent = ScreenGui
Frame.BackgroundColor3 = Color3.fromRGB(35, 0, 70)
Frame.Position = UDim2.new(0.5, -100, 0.5, -75)
Frame.Size = UDim2.new(0, 200, 0, 200)

Title.Parent = Frame
Title.Text = unobfuscateString(obfuscatedStrings[1])
Title.Size = UDim2.new(1, 0, 0.2, 0)
Title.BackgroundColor3 = Color3.fromRGB(20, 0, 40)
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.SourceSans
Title.TextSize = 24

WelcomeMessage.Parent = Frame
WelcomeMessage.Text = unobfuscateString(obfuscatedStrings[2])
WelcomeMessage.Size = UDim2.new(1, 0, 0.2, 0)
WelcomeMessage.Position = UDim2.new(0, 0, 0.2, 0)
WelcomeMessage.BackgroundColor3 = Color3.fromRGB(35, 0, 70)
WelcomeMessage.TextColor3 = Color3.fromRGB(255, 255, 255)
WelcomeMessage.Font = Enum.Font.SourceSans
WelcomeMessage.TextSize = 18

AvatarImage.Parent = Frame
AvatarImage.Size = UDim2.new(0.4, 0, 0.3, 0)
AvatarImage.Position = UDim2.new(0.3, 0, 0.4, 0)
AvatarImage.BackgroundColor3 = Color3.fromRGB(35, 0, 70)
AvatarImage.Image = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. LocalPlayer.UserId .. "&width=150&height=150&format=png"

AimbotButton.Parent = Frame
AimbotButton.Text = unobfuscateString(obfuscatedStrings[3])
AimbotButton.Position = UDim2.new(0, 0, 0.6, 0)
AimbotButton.Size = UDim2.new(1, 0, 0.1, 0)
AimbotButton.BackgroundColor3 = Color3.fromRGB(50, 0, 100)
AimbotButton.TextColor3 = Color3.fromRGB(255, 255, 255)
AimbotButton.Font = Enum.Font.SourceSans
AimbotButton.TextSize = 18

ESPButton.Parent = Frame
ESPButton.Text = unobfuscateString(obfuscatedStrings[4])
ESPButton.Position = UDim2.new(0, 0, 0.7, 0)
ESPButton.Size = UDim2.new(1, 0, 0.1, 0)
ESPButton.BackgroundColor3 = Color3.fromRGB(50, 0, 100)
ESPButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ESPButton.Font = Enum.Font.SourceSans
ESPButton.TextSize = 18

CloseButton.Parent = Frame
CloseButton.Text = "Close"
CloseButton.Position = UDim2.new(0, 0, 0.8, 0)
CloseButton.Size = UDim2.new(1, 0, 0.1, 0)
CloseButton.BackgroundColor3 = Color3.fromRGB(100, 0, 0)
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.Font = Enum.Font.SourceSans
CloseButton.TextSize = 18

-- Functions
local function getClosestPlayer()
    local closestPlayer = nil
    local shortestDistance = math.huge

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local distance = (player.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).magnitude
            if distance < shortestDistance then
                closestPlayer = player
                shortestDistance = distance
            end
        end
    end

    return closestPlayer
end

local function toggleAimbot()
    aimbotEnabled = not aimbotEnabled
end

local function toggleESP()
    espEnabled = not espEnabled
    if espEnabled then
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local billboardGui = Instance.new("BillboardGui")
                billboardGui.Adornee = player.Character.HumanoidRootPart
                billboardGui.Size = UDim2.new(0, 200, 0, 50)
                billboardGui.StudsOffset = Vector3.new(0, 3, 0)
                billboardGui.AlwaysOnTop = true

                local textLabel = Instance.new("TextLabel")
                textLabel.Parent = billboardGui
                textLabel.Size = UDim2.new(1, 0, 1, 0)
                textLabel.BackgroundTransparency = 1
                textLabel.Text = player.Name .. " - " .. player.Character.Humanoid.Health .. " HP"
                textLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
                textLabel.TextStrokeTransparency = 0.5
                textLabel.Font = Enum.Font.SourceSans
                textLabel.TextSize = 14

                billboardGui.Parent = player.Character
            end
        end
    else
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChildOfClass("BillboardGui") then
                player.Character:FindFirstChildOfClass("BillboardGui"):Destroy()
            end
        end
    end
end

local function closeGui()
    ScreenGui:Destroy()
end

-- Event Listeners
AimbotButton.MouseButton1Click:Connect(toggleAimbot)
ESPButton.MouseButton1Click:Connect(toggleESP)
CloseButton.MouseButton1Click:Connect(closeGui)

UserInputService.TouchTap:Connect(function()
    if aimbotEnabled then
        local closestPlayer = getClosestPlayer()
        if closestPlayer then
            LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(LocalPlayer.Character.HumanoidRootPart.Position, closestPlayer.Character.HumanoidRootPart.Position)
        end
    end
end)
